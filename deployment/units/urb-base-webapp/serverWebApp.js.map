{"version":3,"sources":["../../../units/urb-base-webapp/serverWebApp.js"],"names":["require","load","envHost","process","env","HOST","Error","envPort","PORT","envPortWebpack","PORT_WEBPACK","serverWebApp","gatherLocationAndSiteInformation","req","res","assetsPath","siteInformation","NODE_ENV","isSiteBuilderDisabled","inEditingMode","configurationAsObject","version","render","renderError","obj","error","status","log","use","fetcher","cookies","UserToken1","url","historyMiddlewares","routeConfig","resolver","redirect","element","userAgent","headers","appData","sheets","helmet","rewind","rootHTML","renderToString","resolve","__dirname","assets_path","root_html","server_side_styles","toString","JSON","stringify","relay_payload","isJSON","send"],"mappings":";;AAEA,oD;AACA;AACA,gC;AACA,yC;AACA,4B;AACA,0B;AACA;AACA,yC;AACA,yD;;AAEA,8C;AACA;AACA,6C;AACA;AACA,sG;AACA,2C;AACA;AACA,gF;;;AAGAA,QAAQ,QAAR,EAAkBC,IAAlB;;AAEA,GAAMC,SAAUC,QAAQC,GAAR,CAAYC,IAA5B;AACA,GAAIH,SAAW,IAAX,EAAmB,MAAOA,QAAP,GAAmB,QAA1C;AACE,KAAM,IAAII,MAAJ,CAAU,sEAAV,CAAN;;AAEF,GAAMC,SAAUJ,QAAQC,GAAR,CAAYI,IAA5B;AACA,GAAID,SAAW,IAAX,EAAmB,MAAOA,QAAP,GAAmB,QAA1C;AACE,KAAM,IAAID,MAAJ,CAAU,sEAAV,CAAN;;AAEF,GAAMG,gBAAiBN,QAAQC,GAAR,CAAYM,YAAnC;AACA,GAAID,gBAAkB,IAAlB,EAA0B,MAAOA,eAAP,GAA0B,QAAxD;AACE,KAAM,IAAIH,MAAJ,CAAU,8EAAV,CAAN;;;AAGF,GAAMK,cAAe,uBAArB;;AAEA,QAAeC,iCAAf,CAAgDC,GAAhD,CAA6DC,GAA7D;AACMC,UADN;;AAGgC,qCAAmBF,GAAnB,CAAwBC,GAAxB,CAHhC,SAGQE,eAHR;AAIE,GAAIA,eAAJ,CAAqB;AACnB,GAAIb,QAAQC,GAAR,CAAYa,QAAZ,GAAyB,YAA7B,CAA2C;AACzCF;AACEC,gBAAgBE,qBAAhB,EAAyCF,gBAAgBG,aAAzD;;;;AAI+BH,gBAAgBI,qBAAhB,CAAsCC,OALvE;AAMD,CAPD,IAOO;;AAELN,qBAAuBb,OAAvB,KAAkCO,cAAlC;AACD;AACF,CAhBH;;AAkBS,CAAEO,+BAAF,CAAmBD,qBAAnB,CAlBT;;;AAqBA,GAAMO,QAAS,2BAAa;AAC1BC,WAD0B,sBACdC,GADc,CACiB;AACjCC,KADiC,CACvBD,GADuB,CACjCC,KADiC;;AAGzC,GAAIA,MAAMC,MAAN,GAAiB,GAArB;AACE,cAAIC,GAAJ,CAAQ,OAAR,CAAiB,kDAAjB,CAAqEH,GAArE;;AAEF,MAAO,yDAAgB,WAAYC,MAAMC,MAAlC,EAAP;AACD,CARyB,CAAb,CAAf;;;AAWAf,aAAaiB,GAAb,CAAiB,iBAAOf,GAAP,CAAYC,GAAZ;;AAEPe,OAFO,CAEG;AACMtB,OADN;AAEdM,IAAIiB,OAAJ,CAAYC,UAFE,qCAFH;;;;AAQ+B,2BAAe;AACzDC,IAAKnB,IAAImB,GADgD;AAEzDC,6CAFyD;AAGzDC,+BAHyD;AAIzDC,SAAU,2BAAeN,OAAf,CAJ+C;AAKzDP,aALyD,CAAf,CAR/B,6BAQLc,QARK,MAQLA,QARK,CAQKV,MARL,MAQKA,MARL,CAQaW,OARb,MAQaA,OARb;;;AAgBTD,QAhBS;AAiBXtB,IAAIsB,QAAJ,CAAa,GAAb,CAAkBA,SAASJ,GAA3B,EAjBW;;;;AAqBPM,SArBO,CAqBKzB,IAAI0B,OAAJ,CAAY,YAAZ,CArBL;;AAuBiC3B,iCAAiCC,GAAjC,CAAsCC,GAAtC,CAvBjC,+BAuBLE,eAvBK,OAuBLA,eAvBK,CAuBYD,UAvBZ,OAuBYA,UAvBZ;AAwBPyB,OAxBO,CAwBGxB,gBAAgBI,qBAAhB,CAAsCoB,OAxBzC;;AA0BPC,MA1BO,CA0BE,8BA1BF;;AA4BPC,MA5BO,CA4BE,sBAAOC,MAAP,EA5BF;;AA8BPC,QA9BO,CA8BI,iBAAeC,cAAf;AACf,qDAAa,SAAUJ,MAAvB;AACE,iDAAS,UAAWH,SAApB,CAA+B,QAASE,OAAxC;AACGH,OADH,CADF,CADe,CA9BJ;;;;;AAsCbvB,IAAIQ,MAAJ,CAAW,eAAKwB,OAAL,CAAaC,SAAb,CAAwB,UAAxB,CAAX,CAAgD;AAC9CC,YAAajC,UADiC;AAE9CkC,UAAWL,QAFmC;AAG9CM,mBAAoBT,OAAOU,QAAP,EAH0B;AAI9CT,aAJ8C;AAK9CF,QAASY,KAAKC,SAAL,CAAeb,OAAf,CALqC;AAM9Cc,cAAe,kCAAUzB,OAAV,CAAmB,CAAE0B,OAAQ,IAAV,CAAnB,CAN+B,CAAhD,EAtCa;;;AA+Cb,cAAI5B,GAAJ,CAAQ,OAAR,CAAiB,iCAAjB;AACAb,IAAIY,MAAJ,CAAW,GAAX,EAAgB8B,IAAhB,CAAqB,iBAAeX,cAAf,CAA8B,wDAAgB,WAAY,GAA5B,EAA9B,CAArB,EAhDa,oEAAjB,E;;;;AAoDelC,Y","file":"serverWebApp.js","sourcesContent":["// @flow\n\nimport createRender from 'found/lib/createRender'\nimport { getFarceResult } from 'found/lib/server'\nimport express from 'express'\nimport Helmet from 'react-helmet'\nimport React from 'react'\nimport path from 'path'\nimport { JssProvider, SheetsRegistry } from 'react-jss'\nimport ReactDOMServer from 'react-dom/server'\nimport serialize from 'serialize-javascript'\n\nimport FetcherServer from './fetcherServer'\nimport { createResolver, historyMiddlewares, routeConfig } from './router'\nimport Wrapper from './components/Wrapper'\nimport { version } from '../_configuration/package'\nimport UserToken2ServerRendering from '../_configuration/urb-base-server/UserToken2ServerRendering'\nimport log from '../urb-base-server/log'\nimport { getSiteInformation } from '../_configuration/urb-base-server/siteSettings'\nimport ErrorComponent from '../_configuration/urb-base-webapp/ErrorComponent'\n\n// Read environment\nrequire('dotenv').load()\n\nconst envHost = process.env.HOST\nif (envHost == null || typeof envHost !== 'string')\n  throw new Error('ðŸ’”  urb-base-webapp requires the environment variable HOST to be set')\n\nconst envPort = process.env.PORT\nif (envPort == null || typeof envPort !== 'string')\n  throw new Error('ðŸ’”  urb-base-webapp requires the environment variable PORT to be set')\n\nconst envPortWebpack = process.env.PORT_WEBPACK\nif (envPortWebpack == null || typeof envPortWebpack !== 'string')\n  throw new Error('ðŸ’”  urb-base-webapp requires the environment variable PORT_WEBPACK to be set')\n\n// Create express router\nconst serverWebApp = express()\n\nasync function gatherLocationAndSiteInformation(req: Object, res: Object) {\n  let assetsPath\n\n  const siteInformation = await getSiteInformation(req, res)\n  if (siteInformation) {\n    if (process.env.NODE_ENV === 'production') {\n      assetsPath =\n        siteInformation.isSiteBuilderDisabled || siteInformation.inEditingMode\n          ? // When editing in production, use the assets with the configuration readign code intact (built when cutting a site version)\n            `/assets/${version}`\n          : // When in production mode, serve the assets compiled by factory's publisher\n            `/assets-site/${version}.${siteInformation.configurationAsObject.version}`\n    } else {\n      // When in development, always go to webpack over http\n      assetsPath = `http://${envHost}:${envPortWebpack}/${version}`\n    }\n  } // If siteInformation was null, an error response has already been given\n\n  return { siteInformation, assetsPath }\n}\n\nconst render = createRender({\n  renderError(obj: Object): React$Element<*> {\n    const { error } = obj\n\n    if (error.status !== 404)\n      log.log('error', 'Error: Render on server createRender renderError', obj)\n\n    return <ErrorComponent httpStatus={error.status} />\n  },\n})\n\nserverWebApp.use(async (req, res) => {\n  try {\n    const fetcher = new FetcherServer(\n      `http://localhost:${envPort}/graphql`,\n      req.cookies.UserToken1,\n      UserToken2ServerRendering,\n    )\n\n    const { redirect, status, element } = await getFarceResult({\n      url: req.url,\n      historyMiddlewares,\n      routeConfig,\n      resolver: createResolver(fetcher),\n      render,\n    })\n\n    if (redirect) {\n      res.redirect(302, redirect.url)\n      return\n    }\n\n    const userAgent = req.headers['user-agent']\n\n    const { siteInformation, assetsPath } = await gatherLocationAndSiteInformation(req, res)\n    const appData = siteInformation.configurationAsObject.appData\n\n    const sheets = new SheetsRegistry()\n\n    const helmet = Helmet.rewind()\n\n    const rootHTML = ReactDOMServer.renderToString(\n      <JssProvider registry={sheets}>\n        <Wrapper userAgent={userAgent} appData={appData}>\n          {element}\n        </Wrapper>\n      </JssProvider>,\n    )\n\n    res.render(path.resolve(__dirname, 'html.ejs'), {\n      assets_path: assetsPath,\n      root_html: rootHTML,\n      server_side_styles: sheets.toString(),\n      helmet,\n      appData: JSON.stringify(appData),\n      relay_payload: serialize(fetcher, { isJSON: true }),\n    })\n  } catch (err) {\n    log.log('error', 'Error: Render on server request', err)\n    res.status(500).send(ReactDOMServer.renderToString(<ErrorComponent httpStatus={500} />))\n  }\n})\n\nexport default serverWebApp\n"]}