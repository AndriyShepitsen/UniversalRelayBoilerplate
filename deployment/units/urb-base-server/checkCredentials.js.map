{"version":3,"sources":["../../../units/urb-base-server/checkCredentials.js"],"names":["getUserByUserToken1","verifyUserAuthToken","serveAuthenticationFailed","require","load","get_user_id","req","UserToken1","cookies","headers","usertoken1","length","decoded","decode","process","env","JWT_SECRET","uuidFromString","user_id","err","Promise","reject","uuidNull","objectManager","getOneObject","id","User_site_id","siteInformation","site_id","a_User","setViewerUserId","request_UserToken2","get","UserToken2","ip","USER_TOKEN_2_BYPASS_IP","resolve","httpError403FileName","__dirname","res","error","respondWithJSON","connection","remoteAddress","requestDetails","query","body","log","cookie","httpOnly","expires","Date","status","send","sendFile"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AA0BsBA,mB,CAAAA,mB;;;;;;;;;;;;;;;;AAgBNC,mB,CAAAA,mB;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2BAC,yB,CAAAA,yB,CAnEhB,qC,mDACA,0B,yCAEA,4F,iEACA,sG,mFACA,0B,0HAGAC,QAAQ,QAAR,EAAkBC,IAAlB,GAEA,QAASC,YAAT,CAAqBC,GAArB,CAA0B,CACxB,GAAMC,YAAaD,IAAIE,OAAJ,CAAYD,UAAZ,EAA0BD,IAAIG,OAAJ,CAAYC,UAAzD,CACA,GAAIH,UAAJ,CACE,GAAI,CACF,GAAIA,WAAWI,MAAX,CAAoB,EAAxB,CAA4B,CAC1B,GAAMC,SAAU,oBAAIC,MAAJ,CAAWN,UAAX,CAAuBO,QAAQC,GAAR,CAAYC,UAAnC,CAAhB,CACA,MAAO,4BAAiBC,cAAjB,CAAgCL,QAAQM,OAAxC,CAAP,CACD,CACF,CAAC,MAAOC,GAAP,CAAY,CACZ,MAAOC,SAAQC,MAAR,CAAe,mCAAqCF,GAApD,CAAP,CACD,CACH,MAAO,4BAAiBG,QAAjB,EAAP,CACD,CAEM,QAAetB,oBAAf,CAAmCuB,aAAnC,CAAkDjB,GAAlD,iJACCY,OADD,CACWb,YAAYC,GAAZ,CADX,iDAGgBiB,cAAcC,YAAd,CAA2B,MAA3B,CAAmC,CACtDC,GAAIP,OADkD,CAEtDQ,aAAcH,cAAcI,eAAd,CAA8BC,OAFU,CAAnC,CAHhB,SAGCC,MAHD,mBAQDA,MARC,yBASHN,cAAcO,eAAd,CAA8BZ,OAA9B,EATG,gCAUIW,MAVJ,cAYG,oBAZH,0DAgBA,QAAS5B,oBAAT,CAA6B4B,MAA7B,CAAqCvB,GAArC,CAA0C,CAC/C,GAAI,CAACuB,MAAL,CAAa,MAAOT,SAAQC,MAAR,CAAe,oBAAf,CAAP,CAAb,IACK,CACH,GAAMU,oBAAqBzB,IAAI0B,GAAJ,CAAQ,YAAR,CAA3B,CACA,GACED,oBAAsBF,OAAOI,UAA7B,EAEC3B,IAAI4B,EAAJ,EAAU,WAAV,EAAyBH,uDAF1B,EAIAjB,QAAQC,GAAR,CAAYoB,sBAAZ,EAAsC7B,IAAI4B,EAL5C,CAOE,MAAOd,SAAQgB,OAAR,CAAgBP,OAAOJ,EAAvB,CAAP,CAPF,IASE,OAAOL,SAAQC,MAAR,CACL,sCACEQ,OAAOI,UADT,CAEE,aAFF,CAGEF,kBAJG,CAAP,CAMH,CACF,CAED,GAAMM,sBAAuB,eAAKD,OAAL,CAC3BE,SAD2B,CAE3B,sDAF2B,CAA7B,CAKO,QAASpC,0BAAT,CAAmCI,GAAnC,CAAwCiC,GAAxC,CAA6CC,KAA7C,CAAoDC,eAApD,CAAqE;;AAE1E,GAAIP,IAAK5B,IAAIG,OAAJ,CAAY,WAAZ,GAA4BH,IAAIoC,UAAJ,CAAeC,aAApD;;AAEA,GAAMC,gBAAiB;AACrBnC,QAASH,IAAIG,OADQ;AAErBD,QAASF,IAAIE,OAFQ;AAGrB0B,GAAIA,EAHiB;AAIrBW,MAAOvC,IAAIwC,IAJU,CAAvB;;;AAOA,cAAIC,GAAJ,CAAQ,MAAR,CAAgB,6BAAhB,CAA+C,CAAEP,WAAF,CAASI,6BAAT,CAA/C;;;AAGAL,IAAIS,MAAJ,CAAW,YAAX,CAAyB,EAAzB,CAA6B,CAAEC,SAAU,IAAZ,CAAkBC,QAAS,GAAIC,KAAJ,CAAS,CAAT,CAA3B,CAA7B;;AAEA,GAAIV,eAAJ,CAAqBF,IAAIa,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,0CAArB,EAArB;AACKd,IAAIa,MAAJ,CAAW,GAAX,EAAgBE,QAAhB,CAAyBjB,oBAAzB;AACN","file":"checkCredentials.js","sourcesContent":["// @flow weak\n\nimport jwt from 'jwt-simple'\nimport path from 'path'\n\nimport defaultPersister from '../_configuration/urb-base-server/graphql/defaultPersister'\nimport UserToken2ServerRendering from '../_configuration/urb-base-server/UserToken2ServerRendering'\nimport log from './log'\n\n// Read environment\nrequire('dotenv').load()\n\nfunction get_user_id(req) {\n  const UserToken1 = req.cookies.UserToken1 || req.headers.usertoken1\n  if (UserToken1)\n    try {\n      if (UserToken1.length > 10) {\n        const decoded = jwt.decode(UserToken1, process.env.JWT_SECRET)\n        return defaultPersister.uuidFromString(decoded.user_id)\n      }\n    } catch (err) {\n      return Promise.reject('ðŸ’”  Could not read auth cookie. ' + err)\n    }\n  return defaultPersister.uuidNull() // Anonymous, unless cookie is passed\n}\n\nexport async function getUserByUserToken1(objectManager, req) {\n  const user_id = get_user_id(req)\n\n  const a_User = await objectManager.getOneObject('User', {\n    id: user_id,\n    User_site_id: objectManager.siteInformation.site_id,\n  })\n\n  if (a_User) {\n    objectManager.setViewerUserId(user_id)\n    return a_User\n  } else {\n    throw 'ðŸ’”  User not found'\n  }\n}\n\nexport function verifyUserAuthToken(a_User, req) {\n  if (!a_User) return Promise.reject('ðŸ’”  User not found')\n  else {\n    const request_UserToken2 = req.get('UserToken2')\n    if (\n      request_UserToken2 == a_User.UserToken2 ||\n      // A request coming from webapp will come from localhost and will bear the server's user token\n      (req.ip == '127.0.0.1' && request_UserToken2 == UserToken2ServerRendering) ||\n      // For use with GraphiQL\n      process.env.USER_TOKEN_2_BYPASS_IP == req.ip\n    )\n      return Promise.resolve(a_User.id)\n    else\n      return Promise.reject(\n        'ðŸ’”  Authentication token expected: ' +\n          a_User.UserToken2 +\n          ', provided:' +\n          request_UserToken2,\n      )\n  }\n}\n\nconst httpError403FileName = path.resolve(\n  __dirname,\n  '../_configuration/urb-base-server/httpError/403.html',\n)\n\nexport function serveAuthenticationFailed(req, res, error, respondWithJSON) {\n  // Collect information about the request\n  var ip = req.headers['x-real-ip'] || req.connection.remoteAddress\n\n  const requestDetails = {\n    headers: req.headers,\n    cookies: req.cookies,\n    ip: ip,\n    query: req.body,\n  }\n\n  log.log('warn', 'Checking credentials failed', { error, requestDetails })\n\n  // Expire cookie. This is the only way to 'delete' a cookie\n  res.cookie('UserToken1', '', { httpOnly: true, expires: new Date(1) })\n\n  if (respondWithJSON) res.status(403).send('{ \"error\": \"ðŸ’”  Authentication Failed\" }')\n  else res.status(403).sendFile(httpError403FileName)\n}\n"]}